<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kliniksuche ‚Äì BFHI</title>
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --blue:       #004a99;
    --blue-light: #e8f0fe;
    --orange:     #ff8c00;
    --orange-light: #fff4e6;
    --grey:       #bdc3c7;
    --green:      #27ae60;
    --text:       #1a1a2e;
    --text-muted: #6b7280;
    --border:     #f0f0f0;
    --bg:         #f8faff;
    --white:      #ffffff;
    --shadow-sm:  0 2px 8px rgba(0,74,153,0.08);
    --shadow-md:  0 4px 20px rgba(0,74,153,0.12);
    --shadow-lg:  0 8px 40px rgba(0,74,153,0.18);
  }

  html, body { height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  #app { display: flex; height: 100%; width: 100%; }
  #map { flex: 1; height: 100%; }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  #sidebar {
    width: 400px; min-width: 400px; height: 100%;
    display: flex; flex-direction: column;
    background: var(--white);
    box-shadow: var(--shadow-lg);
    z-index: 10;
  }

  @media (max-width: 768px) {
    #app { position: relative; }
    #map { position: absolute; inset: 0; }
    #sidebar {
      position: absolute; bottom: 0; left: 0; right: 0;
      width: 100%; min-width: unset; height: 88vh;
      border-radius: 24px 24px 0 0;
      transform: translateY(calc(88vh - 175px));
      transition: transform 0.32s cubic-bezier(0.25,0.46,0.45,0.94);
      will-change: transform;
    }
    #sidebar.open { transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  #header {
    background: linear-gradient(135deg, #004a99 0%, #0066cc 100%);
    padding: 16px 20px 24px; flex-shrink: 0;
    position: relative; overflow: hidden;
  }
  #header::before {
    content: ''; position: absolute; top: -40px; right: -40px;
    width: 150px; height: 150px; border-radius: 50%;
    background: rgba(255,255,255,0.06);
  }
  #header::after {
    content: ''; position: absolute; bottom: -30px; left: -20px;
    width: 100px; height: 100px; border-radius: 50%;
    background: rgba(255,255,255,0.04);
  }

  .drag-handle {
    width: 44px; height: 5px;
    background: rgba(255,255,255,0.3); border-radius: 10px;
    margin: 0 auto 14px; display: none; cursor: grab;
  }
  @media (max-width: 768px) { .drag-handle { display: block; } }

  .header-title {
    display: flex; align-items: center; justify-content: center;
    gap: 10px; margin-bottom: 18px;
  }
  .header-title .logo {
    width: 36px; height: 36px; background: rgba(255,255,255,0.15);
    border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 20px;
  }
  .header-title h1 { font-size: 20px; font-weight: 700; color: white; letter-spacing: 0.3px; }

  /* Search Box */
  .search-box {
    background: white; border-radius: 16px;
    padding: 16px; box-shadow: var(--shadow-md);
    position: relative; z-index: 1;
  }

  .plz-row {
    display: flex; gap: 10px; margin-bottom: 10px;
  }
  .plz-wrap {
    flex: 1; position: relative;
  }
  .plz-wrap .icon {
    position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
    font-size: 16px; pointer-events: none;
  }
  .plz-wrap input {
    width: 100%; padding: 12px 12px 12px 38px;
    border: 2px solid #e8edf5; border-radius: 10px;
    font-size: 15px; color: var(--text); outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }
  .plz-wrap input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,74,153,0.1); }
  .plz-wrap input::placeholder { color: #aab; }

  .filter-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
  .select-wrap { position: relative; }
  .select-wrap select {
    width: 100%; padding: 11px 32px 11px 12px;
    border: 2px solid #e8edf5; border-radius: 10px;
    font-size: 14px; color: var(--text); background: white;
    -webkit-appearance: none; appearance: none; outline: none;
    cursor: pointer; transition: border-color 0.2s;
  }
  .select-wrap select:focus { border-color: var(--blue); }
  .select-wrap::after {
    content: '‚ñæ'; position: absolute; right: 10px; top: 50%;
    transform: translateY(-50%); color: var(--text-muted);
    pointer-events: none; font-size: 13px;
  }

  .btn-row { display: flex; gap: 8px; }
  .btn-search {
    flex: 2; padding: 13px; border: none; border-radius: 10px;
    background: linear-gradient(135deg, var(--orange) 0%, #ff6b00 100%);
    color: white; font-size: 15px; font-weight: 700; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    box-shadow: 0 4px 12px rgba(255,140,0,0.35);
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .btn-search:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(255,140,0,0.45); }
  .btn-search:active { transform: translateY(0); }
  .btn-reset {
    flex: 1; padding: 13px; border: 2px solid #e8edf5; border-radius: 10px;
    background: white; color: var(--text-muted); font-size: 14px; cursor: pointer;
    transition: all 0.15s;
  }
  .btn-reset:hover { border-color: var(--blue); color: var(--blue); }

  /* ‚îÄ‚îÄ Stats Bar ‚îÄ‚îÄ */
  #statsBar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 20px; background: var(--bg);
    border-bottom: 1px solid var(--border); flex-shrink: 0;
    font-size: 12px; color: var(--text-muted);
  }
  #statsBar .count { font-weight: 700; color: var(--blue); }
  .legend { display: flex; gap: 14px; }
  .dot { width: 9px; height: 9px; border-radius: 50%; display: inline-block; margin-right: 4px; vertical-align: middle; }

  /* ‚îÄ‚îÄ Results ‚îÄ‚îÄ */
  #results { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; padding: 8px 0; }

  .empty-state {
    padding: 50px 20px; text-align: center; color: var(--text-muted);
  }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.6; }
  .empty-state p { font-size: 15px; line-height: 1.6; }

  /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
  .card {
    margin: 8px 12px; border-radius: 16px;
    background: var(--white); border: 1.5px solid var(--border);
    cursor: pointer; overflow: hidden;
    transition: transform 0.18s, box-shadow 0.18s, border-color 0.18s;
    animation: fadeUp 0.25s ease both;
  }
  .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: #d0dff5; }
  .card.active { border-color: var(--orange); box-shadow: 0 4px 16px rgba(255,140,0,0.2); }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .card-inner { padding: 16px; }

  .card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
  .card-name { font-size: 15px; font-weight: 700; color: var(--text); line-height: 1.3; }
  .card-dist {
    background: var(--blue-light); color: var(--blue);
    font-size: 11px; font-weight: 700; padding: 3px 8px;
    border-radius: 20px; white-space: nowrap; flex-shrink: 0; margin-top: 2px;
  }

  .card-typ {
    display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px;
  }
  .typ-chip {
    background: #f0f4ff; color: var(--blue);
    font-size: 11px; font-weight: 600; padding: 3px 9px;
    border-radius: 20px;
  }

  .card-addr { font-size: 12px; color: var(--text-muted); line-height: 1.6; }

  /* Badge */
  .badge-row { margin-top: 10px; }
  .badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 5px 12px; border-radius: 20px;
    font-size: 11px; font-weight: 700;
  }
  .badge.zert {
    background: linear-gradient(135deg, #fff4e6, #ffe8cc);
    color: #d4600a; border: 1.5px solid #ffd0a0;
  }
  .badge.nicht-zert {
    background: #f5f5f5; color: #888;
    border: 1.5px solid #e0e0e0;
  }
  .badge .badge-dot {
    width: 7px; height: 7px; border-radius: 50%;
  }

  /* Card Footer */
  .card-footer {
    border-top: 1px solid var(--border);
    padding: 10px 16px;
    display: flex; gap: 8px;
  }
  .btn-web {
    flex: 1; padding: 9px 12px; border-radius: 10px;
    text-decoration: none; font-size: 13px; font-weight: 600;
    text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px;
    background: var(--blue-light); color: var(--blue);
    transition: background 0.15s;
  }
  .btn-web:hover { background: #d0e0f8; }

  /* ‚îÄ‚îÄ URL Bar ‚îÄ‚îÄ */
  #urlbar {
    padding: 7px 16px; background: var(--bg); border-top: 1px solid var(--border);
    font-size: 10px; color: #aaa; text-align: center; flex-shrink: 0;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  #toast {
    position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(16px);
    color: white; padding: 12px 22px; border-radius: 30px;
    font-size: 13px; font-weight: 600; z-index: 9999;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s, transform 0.25s;
    white-space: nowrap; box-shadow: var(--shadow-lg);
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* ‚îÄ‚îÄ Loader ‚îÄ‚îÄ */
  #loader {
    position: fixed; inset: 0; background: rgba(248,250,255,0.92);
    display: flex; align-items: center; justify-content: center;
    z-index: 9998; flex-direction: column; gap: 16px;
  }
  .spinner {
    width: 44px; height: 44px; border: 4px solid #e0e8f5;
    border-top-color: var(--blue); border-radius: 50%;
    animation: spin 0.75s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loader-text { color: var(--text-muted); font-size: 14px; font-weight: 500; }

  /* MapLibre overrides */
  .maplibregl-ctrl-logo { display: none !important; }
</style>
</head>
<body>

<div id="app">
  <div id="map"></div>

  <div id="sidebar">
    <div class="drag-handle" id="dragHandle"></div>

    <div id="header">
      <div class="header-title">
        <div class="logo">üè•</div>
        <h1>Kliniksuche</h1>
      </div>
      <div class="search-box">
        <div class="plz-row">
          <div class="plz-wrap">
            <span class="icon">üìç</span>
            <input type="text" id="plzInput" placeholder="PLZ eingeben‚Ä¶" inputmode="numeric" maxlength="5" aria-label="Postleitzahl">
          </div>
        </div>
        <div class="filter-row">
          <div class="select-wrap">
            <select id="radiusInput" aria-label="Suchradius">
              <option value="20">20 km</option>
              <option value="50" selected>50 km</option>
              <option value="100">100 km</option>
              <option value="200">200 km</option>
            </select>
          </div>
          <div class="select-wrap">
            <select id="typInput" aria-label="Kliniktyp">
              <option value="">Alle Typen</option>
              <option value="Geburtsklinik">Geburtsklinik</option>
              <option value="Kinderklinik">Kinderklinik</option>
              <option value="Neonatologie">Neonatologie</option>
              <option value="Perinatalklinik">Perinatalklinik</option>
            </select>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn-search" id="btnSuchen">üîç Suchen</button>
          <button class="btn-reset"  id="btnReset">‚Ü∫ Reset</button>
        </div>
      </div>
    </div>

    <div id="statsBar">
      <span id="statsText" class="count">Wird geladen‚Ä¶</span>
      <div class="legend">
        <span><span class="dot" style="background:var(--orange)"></span>Zertifiziert</span>
        <span><span class="dot" style="background:var(--grey)"></span>Nicht zertifiziert</span>
      </div>
    </div>

    <div id="results">
      <div class="empty-state"><div class="icon">‚è≥</div><p>Kliniken werden geladen‚Ä¶</p></div>
    </div>

    <div id="urlbar">bfhi.github.io/kliniksuche</div>
  </div>
</div>

<div id="loader">
  <div class="spinner"></div>
  <span class="loader-text">Kliniken werden geladen‚Ä¶</span>
</div>
<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MAPTILER_KEY = 'Elf3H81mTSidOeZvhMdD';
const DATA_URL     = 'https://cdn.jsdelivr.net/gh/BFHI/kliniksuche@main/kliniken.json';

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const state = {
  kliniken: [], treffer: [],
  filter: { plz: '', lat: null, lon: null, radius: 50, typ: '' },
  activeId: null
};

// ‚îÄ‚îÄ Karte ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const map = new maplibregl.Map({
  container: 'map',
  style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`,
  center: [10.4515, 51.1657],
  zoom: 5.5,
  attributionControl: false
});
map.addControl(new maplibregl.NavigationControl(), 'top-right');

const popups = new Map();

map.on('load', () => {
  // Quellen & Layer f√ºr Cluster
  map.addSource('kliniken', {
    type: 'geojson', data: { type: 'FeatureCollection', features: [] },
    cluster: true, clusterMaxZoom: 12, clusterRadius: 50
  });

  // Cluster-Kreise
  map.addLayer({ id: 'clusters', type: 'circle', source: 'kliniken',
    filter: ['has', 'point_count'],
    paint: {
      'circle-color': ['step', ['get', 'point_count'], '#004a99', 10, '#0066cc', 30, '#0080ff'],
      'circle-radius': ['step', ['get', 'point_count'], 18, 10, 24, 30, 30],
      'circle-opacity': 0.9,
      'circle-stroke-color': '#fff', 'circle-stroke-width': 2
    }
  });

  // Cluster-Zahlen
  map.addLayer({ id: 'cluster-count', type: 'symbol', source: 'kliniken',
    filter: ['has', 'point_count'],
    layout: { 'text-field': '{point_count_abbreviated}', 'text-size': 13, 'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'] },
    paint: { 'text-color': '#fff' }
  });

  // Einzelpunkte ‚Äì zertifiziert
  map.addLayer({ id: 'punkte-zert', type: 'circle', source: 'kliniken',
    filter: ['all', ['!', ['has', 'point_count']], ['==', ['get', 'zertifiziert'], true]],
    paint: {
      'circle-radius': ['interpolate', ['linear'], ['zoom'], 5, 7, 12, 12],
      'circle-color': '#ff8c00', 'circle-opacity': 0.92,
      'circle-stroke-color': '#fff', 'circle-stroke-width': 2
    }
  });

  // Einzelpunkte ‚Äì nicht zertifiziert
  map.addLayer({ id: 'punkte-nicht', type: 'circle', source: 'kliniken',
    filter: ['all', ['!', ['has', 'point_count']], ['==', ['get', 'zertifiziert'], false]],
    paint: {
      'circle-radius': ['interpolate', ['linear'], ['zoom'], 5, 5, 12, 9],
      'circle-color': '#bdc3c7', 'circle-opacity': 0.85,
      'circle-stroke-color': '#fff', 'circle-stroke-width': 1.5
    }
  });

  // Klick auf Cluster ‚Üí reinzoomen
  map.on('click', 'clusters', e => {
    const f = map.queryRenderedFeatures(e.point, { layers: ['clusters'] })[0];
    const src = map.getSource('kliniken');
    src.getClusterExpansionZoom(f.properties.cluster_id, (err, zoom) => {
      if (err) return;
      map.easeTo({ center: f.geometry.coordinates, zoom });
    });
  });

  // Klick auf Punkt ‚Üí Popup & Card
  ['punkte-zert', 'punkte-nicht'].forEach(layer => {
    map.on('click', layer, e => {
      const p = e.features[0].properties;
      const coords = e.features[0].geometry.coordinates;
      showPopup(p.id, p.name, p.typ, coords);
      highlightCard(p.id);
    });
    map.on('mouseenter', layer, () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', layer, () => map.getCanvas().style.cursor = '');
  });
  map.on('mouseenter', 'clusters', () => map.getCanvas().style.cursor = 'pointer');
  map.on('mouseleave', 'clusters', () => map.getCanvas().style.cursor = '');

  map.on('click', e => {
    const f = map.queryRenderedFeatures(e.point, { layers: ['punkte-zert','punkte-nicht','clusters'] });
    if (!f.length && isMobile()) sidebar.classList.remove('open');
  });

  // Daten laden sobald Karte bereit
  datenLaden();
});

function setGeoJSON(daten) {
  const src = map.getSource('kliniken');
  if (!src) return;
  src.setData({
    type: 'FeatureCollection',
    features: daten.map(k => ({
      type: 'Feature',
      geometry: { type: 'Point', coordinates: [k._jLon, k._jLat] },
      properties: { id: k.id, name: k.firmenname, typ: k.typ.join(', '), zertifiziert: k.zertifiziert }
    }))
  });
}

function showPopup(id, name, typ, coords) {
  // Alte Popups schlie√üen
  popups.forEach(p => p.remove()); popups.clear();
  const popup = new maplibregl.Popup({ offset: 12, closeButton: true, maxWidth: '240px' })
    .setLngLat(coords)
    .setHTML(`<div style="font-family:'Segoe UI',sans-serif;padding:4px 2px">
      <b style="font-size:14px;color:#1a1a2e">${name}</b>
      <div style="font-size:12px;color:#d35400;margin-top:3px">${typ}</div>
    </div>`)
    .addTo(map);
  popups.set(id, popup);
}

// ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const sidebar    = document.getElementById('sidebar');
const plzInput   = document.getElementById('plzInput');
const radiusInput= document.getElementById('radiusInput');
const typInput   = document.getElementById('typInput');
const results    = document.getElementById('results');
const statsText  = document.getElementById('statsText');
const urlbar     = document.getElementById('urlbar');
const loader     = document.getElementById('loader');
const isMobile   = () => window.innerWidth <= 768;

// ‚îÄ‚îÄ Touch Swipe ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let touchY0 = 0, translateY0 = 0, dragging = false;
function getTranslateY() { return new WebKitCSSMatrix(window.getComputedStyle(sidebar).transform).m42; }

document.getElementById('dragHandle').addEventListener('touchstart', e => {
  if (!isMobile()) return;
  dragging = true; touchY0 = e.touches[0].clientY; translateY0 = getTranslateY();
  sidebar.style.transition = 'none';
}, { passive: true });
document.addEventListener('touchmove', e => {
  if (!dragging) return;
  const maxY = window.innerHeight * 0.88 - 175;
  sidebar.style.transform = `translateY(${Math.max(0, Math.min(maxY, translateY0 + e.touches[0].clientY - touchY0))}px)`;
}, { passive: true });
document.addEventListener('touchend', () => {
  if (!dragging) return; dragging = false; sidebar.style.transition = '';
  const cur = getTranslateY(), snap = window.innerHeight * 0.88 * 0.45;
  sidebar.classList.toggle('open', cur < snap); sidebar.style.transform = '';
});
document.getElementById('dragHandle').addEventListener('click', () => { if (isMobile()) sidebar.classList.toggle('open'); });

// ‚îÄ‚îÄ URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function leseURL() {
  const p = new URLSearchParams(location.search);
  if (p.get('plz'))    plzInput.value    = p.get('plz');
  if (p.get('radius')) radiusInput.value = p.get('radius');
  if (p.get('typ'))    typInput.value    = p.get('typ');
}
function schreibeURL() {
  const p = new URLSearchParams();
  if (state.filter.plz) p.set('plz', state.filter.plz);
  p.set('radius', state.filter.radius);
  if (state.filter.typ) p.set('typ', state.filter.typ);
  history.replaceState(null, '', p.toString() ? '?' + p : location.pathname);
  urlbar.textContent = 'bfhi.github.io/kliniksuche' + (p.toString() ? '?' + p : '');
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function toast(msg, color = '#1a1a2e') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.style.background = color;
  el.classList.add('show'); clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3500);
}

// ‚îÄ‚îÄ Daten ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function datenLaden() {
  try {
    const res  = await fetch(DATA_URL);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    state.kliniken = json.kliniken
      .filter(k => k.aktiv && !isNaN(k.lat) && !isNaN(k.lon))
      .map(k => ({ ...k,
        _jLat: k.lat + (Math.random() - 0.5) * 0.005,
        _jLon: k.lon + (Math.random() - 0.5) * 0.005
      }));
    loader.style.display = 'none';
    leseURL();
    if (plzInput.value) await sucheStarten();
    else alleAnzeigen();
  } catch(e) {
    loader.style.display = 'none';
    toast('‚ö†Ô∏è Daten konnten nicht geladen werden.', '#c0392b');
    results.innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Daten nicht verf√ºgbar.<br>Bitte sp√§ter erneut versuchen.</p></div>`;
  }
}

// ‚îÄ‚îÄ Suche ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sucheStarten() {
  const plz = plzInput.value.trim(), radius = parseInt(radiusInput.value), typ = typInput.value;
  if (!plz) { toast('‚ö†Ô∏è Bitte eine PLZ eingeben.', '#e67e22'); return; }
  if (!/^\d{5}$/.test(plz)) { toast('‚ö†Ô∏è Bitte eine g√ºltige 5-stellige PLZ eingeben.', '#e67e22'); return; }
  try {
    const data = await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&postalcode=${plz}&country=germany`)).json();
    if (!data.length) { toast(`‚ùå PLZ ${plz} nicht gefunden.`, '#c0392b'); return; }
    const sLat = parseFloat(data[0].lat), sLon = parseFloat(data[0].lon);
    state.filter = { plz, lat: sLat, lon: sLon, radius, typ };
    state.treffer = state.kliniken
      .map(k => ({ ...k, _dist: distanz(sLat, sLon, k.lat, k.lon) }))
      .filter(k => k._dist <= radius && (!typ || k.typ.includes(typ)))
      .sort((a, b) => a._dist - b._dist);
    if (!state.treffer.length) toast(`Keine Kliniken im Umkreis von ${radius} km.`, '#7f8c8d');
    map.easeTo({ center: [sLon, sLat], zoom: 10 });
    setGeoJSON(state.treffer);
    renderListe(state.treffer, true);
    schreibeURL();
    if (isMobile()) sidebar.classList.add('open');
  } catch(e) { toast('‚ö†Ô∏è Netzwerkfehler.', '#c0392b'); }
}

function alleAnzeigen() {
  plzInput.value = ''; radiusInput.value = 50; typInput.value = '';
  state.filter = { plz: '', lat: null, lon: null, radius: 50, typ: '' };
  state.treffer = state.kliniken;
  map.easeTo({ center: [10.4515, 51.1657], zoom: 5.5 });
  setGeoJSON(state.kliniken);
  renderListe(state.kliniken, false);
  schreibeURL();
}

function distanz(lat1, lon1, lat2, lon2) {
  const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ‚îÄ‚îÄ Liste ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderListe(daten, mitDistanz) {
  const zert = daten.filter(k => k.zertifiziert).length;
  statsText.innerHTML = `<span class="count">${daten.length}</span> Klinik${daten.length !== 1 ? 'en' : ''} ¬∑ <span style="color:var(--orange);font-weight:700">${zert} zertifiziert</span>`;

  if (!daten.length) {
    results.innerHTML = `<div class="empty-state"><div class="icon">üîç</div><p>Keine Kliniken gefunden.<br>Versuche einen gr√∂√üeren Radius.</p></div>`;
    return;
  }

  results.innerHTML = daten.map((k, i) => {
    const url = k.webseite ? (k.webseite.startsWith('http') ? k.webseite : 'https://' + k.webseite) : null;
    return `<div class="card" id="card-${k.id}" style="animation-delay:${Math.min(i * 30, 300)}ms"
      onclick="fokusKlinik('${k.id}', ${k.lat}, ${k.lon}, ${k._jLon}, ${k._jLat})">
      <div class="card-inner">
        <div class="card-top">
          <div class="card-name">${k.firmenname}</div>
          ${mitDistanz ? `<div class="card-dist">üìç ${k._dist.toFixed(1).replace('.',',')} km</div>` : ''}
        </div>
        <div class="card-typ">${k.typ.map(t => `<span class="typ-chip">${t}</span>`).join('')}</div>
        <div class="card-addr">${k.strasse}, ${k.plz} ${k.ort}</div>
        <div class="badge-row">
          ${k.zertifiziert
            ? `<span class="badge zert"><span class="badge-dot" style="background:#ff8c00"></span>‚úì Baby-Friendly zertifiziert</span>`
            : `<span class="badge nicht-zert"><span class="badge-dot" style="background:#bdc3c7"></span>Noch nicht zertifiziert</span>`}
        </div>
      </div>
      ${url ? `<div class="card-footer"><a href="${url}" target="_blank" class="btn-web" onclick="event.stopPropagation()">üåê Zur Webseite</a></div>` : ''}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Interaktion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function highlightCard(id) {
  document.querySelectorAll('.card.active').forEach(el => el.classList.remove('active'));
  const el = document.getElementById('card-' + id);
  if (!el) return;
  if (isMobile()) sidebar.classList.add('open');
  setTimeout(() => { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.classList.add('active'); }, 200);
}

function fokusKlinik(id, lat, lon, jLon, jLat) {
  if (isMobile()) sidebar.classList.remove('open');
  map.easeTo({ center: [jLon, jLat], zoom: 14 });
  showPopup(id, document.querySelector(`#card-${id} .card-name`)?.textContent || '', '', [jLon, jLat]);
  highlightCard(id);
}

// ‚îÄ‚îÄ Events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
plzInput.addEventListener('keydown', e => { if (e.key === 'Enter') sucheStarten(); });
document.getElementById('btnSuchen').addEventListener('click', sucheStarten);
document.getElementById('btnReset').addEventListener('click', alleAnzeigen);
</script>
</body>
</html>